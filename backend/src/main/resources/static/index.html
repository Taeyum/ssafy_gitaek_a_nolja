<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œìŠ¤í…œ ìµœì¢… ì ê²€ (JWT Diagnostic)</title>
    <style>
        body { font-family: 'Consolas', 'Malgun Gothic', sans-serif; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: #252526; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #3e3e42; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h1 { color: #61afef; text-align: center; margin-bottom: 30px; }
        h2 { margin-top: 0; color: #98c379; border-bottom: 1px solid #3e3e42; padding-bottom: 10px; font-size: 1.2em; }
        
        .status-box { background: #333; padding: 10px; border-radius: 4px; margin-bottom: 15px; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center; }
        .token-text { color: #e5c07b; font-size: 0.9em; word-break: break-all; margin-right: 10px; }
        
        input { width: 100%; padding: 10px; margin-top: 5px; background: #3c3c3c; border: 1px solid #555; color: white; box-sizing: border-box; border-radius: 4px; }
        input:focus { border-color: #61afef; outline: none; }
        
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-blue { background: #61afef; color: #282c34; }
        .btn-green { background: #98c379; color: #282c34; }
        .btn-red { background: #e06c75; color: #282c34; }
        
        .log-area { background: #000; padding: 15px; border-radius: 4px; font-size: 13px; min-height: 80px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #444; color: #ccc; margin-top: 10px; font-family: 'Consolas', monospace; }
        .success { color: #98c379; }
        .error { color: #e06c75; }
        .info { color: #61afef; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’‰ ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ ì§„ë‹¨</h1>

    <div class="card">
        <h2>0. í˜„ì¬ ì¸ì¦ ìƒíƒœ (localStorage)</h2>
        <div class="status-box">
            <span id="tokenStatus" class="token-text">í† í° ì—†ìŒ</span>
            <button class="btn-red" style="width: auto; margin: 0; padding: 5px 10px;" onclick="clearToken()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="card">
        <h2>1. íšŒì›ê°€ì… (POST /api/users)</h2>
        <input type="text" id="joinEmail" placeholder="ì´ë©”ì¼ (ì˜ˆ: test@ssafy.com)">
        <input type="password" id="joinPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì˜ˆ: 1234)">
        <input type="text" id="joinNick" placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: í…ŒìŠ¤í„°)">
        <button class="btn-blue" onclick="doSignup()">ğŸš€ íšŒì›ê°€ì… ìš”ì²­</button>
        <div id="joinLog" class="log-area">ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div class="card">
        <h2>2. ë¡œê·¸ì¸ (POST /api/users/login)</h2>
        <input type="text" id="loginEmail" placeholder="ì´ë©”ì¼ (admin@ssafy.com)">
        <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (1234)">
        <button class="btn-green" onclick="doLogin()">ğŸ”‘ ë¡œê·¸ì¸ (JWT í† í° ë°œê¸‰)</button>
        <div id="loginLog" class="log-area">ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div class="card">
        <h2>3. í† í° ê²€ì¦ (GET /api/users/me)</h2>
        <p style="font-size: 0.9em; color: #aaa;">* í—¤ë”ì— <code>Authorization: Bearer í† í°</code>ì„ ì‹¤ì–´ ë³´ëƒ…ë‹ˆë‹¤.</p>
        <button class="btn-blue" onclick="getMyInfo()">ğŸ“‘ ë‚´ ì •ë³´ ì¡°íšŒ (ì¸ì¦ í™•ì¸)</button>
        <div id="meLog" class="log-area">ëŒ€ê¸° ì¤‘...</div>
    </div>
    
    
    
    
</div>


<div class="card" style="border: 1px solid #e5c07b;">
        <h2 style="color: #e5c07b;">4. ê´€ë¦¬ì ì „ìš© (ë°ì´í„° ìˆ˜ì§‘)</h2>
        <p style="font-size: 0.9em; color: #aaa;">
            * ì£¼ì†Œ: <b>GET /api/admin/load-data</b><br>
            * ì¡°ê±´: í—¤ë”ì— í† í° í•„ìˆ˜ + ê´€ë¦¬ì(ADMIN) ê¶Œí•œ í•„ìš”
        </p>
        <button class="btn-warning" style="background: #e5c07b; color: #282c34;" onclick="loadData()">ğŸ“¥ ê´€ê´‘ì§€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘</button>
        <div id="adminLog" class="log-area">ëŒ€ê¸° ì¤‘...</div>
    </div>


<script>
    // 1. ì‹œì‘ ì‹œ í† í° ìƒíƒœ í™•ì¸
    checkToken();

    function checkToken() {
        const token = localStorage.getItem("accessToken");
        const display = document.getElementById("tokenStatus");
        if(token) {
            display.innerHTML = `âœ… í† í° ë³´ìœ ì¤‘ (${token.substring(0, 15)}...)`;
            display.style.color = "#98c379";
        } else {
            display.innerText = "âŒ í† í° ì—†ìŒ (ë¡œê·¸ì¸ í•„ìš”)";
            display.style.color = "#e06c75";
        }
    }

    function clearToken() {
        localStorage.removeItem("accessToken");
        checkToken();
        log("loginLog", "í† í°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        log("meLog", "í† í°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function log(id, msg, isError = false) {
        const el = document.getElementById(id);
        el.innerHTML = isError ? `<span class="error">${msg}</span>` : `<span class="success">${msg}</span>`;
    }

    // â˜… [í•µì‹¬] API í†µì‹  í•¨ìˆ˜ (fetch)
    async function callApi(name, url, method, data, logId) {
        const logBox = document.getElementById(logId);
        logBox.innerHTML = `<span class="info">â³ [${name}] ìš”ì²­ ë³´ë‚´ëŠ” ì¤‘...</span>`;

        // 1. í—¤ë” ì„¤ì •
        const headers = { "Content-Type": "application/json" };
        
        // 2. í† í° ìˆìœ¼ë©´ ìë™ ì¶”ê°€ (Bearer ë°©ì‹)
        const token = localStorage.getItem("accessToken");
        if (token) {
            headers["Authorization"] = `Bearer ${token}`;
        }

        try {
            const options = {
                method: method,
                headers: headers,
                body: data ? JSON.stringify(data) : null
            };

            const response = await fetch(url, options);
            const text = await response.text(); // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë°›ìŒ

            if (response.ok) {
                // ì„±ê³µ (200 OK ë“±)
                logBox.innerHTML = `<span class="success">âœ… ì„±ê³µ (${response.status})</span>\n\nì‘ë‹µ ë°ì´í„°:\n${text}`;
                return text;
            } else {
                // ì‹¤íŒ¨ (401, 403, 500 ë“±)
                logBox.innerHTML = `<span class="error">ğŸ’¥ ì‹¤íŒ¨ (${response.status})</span>\n\nì„œë²„ ë©”ì‹œì§€:\n${text}`;
                return null;
            }
        } catch (error) {
            logBox.innerHTML = `<span class="error">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (ì„œë²„ êº¼ì§?)</span>\n${error}`;
            return null;
        }
    }

    // --- ê¸°ëŠ¥ êµ¬í˜„ ---

    async function doSignup() {
        const data = {
            email: document.getElementById("joinEmail").value,
            password: document.getElementById("joinPw").value,
            nickname: document.getElementById("joinNick").value
        };
        await callApi("íšŒì›ê°€ì…", "/api/users", "POST", data, "joinLog");
    }

    async function doLogin() {
        const data = {
            email: document.getElementById("loginEmail").value,
            password: document.getElementById("loginPw").value
        };
        
        // ë¡œê·¸ì¸ ìš”ì²­
        const result = await callApi("ë¡œê·¸ì¸", "/api/users/login", "POST", data, "loginLog");
        
        if (result) {
            // ë°±ì—”ë“œê°€ í† í° ë¬¸ìì—´(String)ì„ ê·¸ëŒ€ë¡œ ì¤¬ëŠ”ì§€, JSONìœ¼ë¡œ ì¤¬ëŠ”ì§€ í™•ì¸
            let token = result;
            try {
                // í˜¹ì‹œ JSON ê°ì²´ë¼ë©´ íŒŒì‹± ({ "accessToken": "..." })
                const json = JSON.parse(result);
                if (json.accessToken) token = json.accessToken;
            } catch(e) {
                // íŒŒì‹± ì—ëŸ¬ë‚˜ë©´ ê·¸ëƒ¥ ë¬¸ìì—´ ìì²´ê°€ í† í°ì´ë¼ê³  ê°€ì •
            }

            if (token && !token.includes("Error") && !token.includes("{")) {
                localStorage.setItem("accessToken", token);
                checkToken();
                document.getElementById("loginLog").innerHTML += `\n\n<span class="success">ğŸ‰ í† í° ì €ì¥ ì™„ë£Œ! ì´ì œ [3. ë‚´ ì •ë³´ ì¡°íšŒ]ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</span>`;
            }
        }
    }

    async function getMyInfo() {
        await callApi("ë‚´ ì •ë³´ ì¡°íšŒ", "/api/users/me", "GET", null, "meLog");
    }
    
    async function loadData() {
        // 1. ê´€ë¦¬ì ê¸°ëŠ¥ í˜¸ì¶œ (í† í°ì€ callApiê°€ ì•Œì•„ì„œ ë„£ì–´ì¤Œ)
        await callApi("ë°ì´í„° ìˆ˜ì§‘", "/api/admin/load-data", "GET", null, "adminLog");
    }
    
    
</script>

</body>
</html>