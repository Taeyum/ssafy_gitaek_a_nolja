<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.gitaek.mapper.TripMapper">

	<insert id="insertTrip"
		parameterType="com.ssafy.gitaek.model.Trip" useGeneratedKeys="true"
		keyProperty="tripId">
		INSERT INTO Trip (title, style, description, start_date,
		end_date, owner_id, max_participants, region_id, created_at,
		invite_code)
		VALUES (#{title}, #{style}, #{description}, #{startDate},
		#{endDate}, #{ownerId}, #{maxParticipants}, #{regionId}, NOW(),
		#{inviteCode})
	</insert>

	<insert id="insertParticipant">
		INSERT INTO Trip_Participant (trip_id, user_id,
		joined_at, role)
		VALUES (#{tripId}, #{userId}, NOW(), #{role})
	</insert>

	<select id="selectMyTrips" resultType="com.ssafy.gitaek.model.Trip">
		SELECT t.trip_id AS tripId, 
		       t.title, 
		       t.style,
		       t.start_date AS startDate, 
		       t.end_date AS endDate, 
		       t.owner_id AS ownerId, 
		       t.max_participants AS maxParticipants,
		       t.region_id AS regionId, 
		       t.current_editor_id AS currentEditorId,
		       t.invite_code AS inviteCode,  (SELECT COUNT(*) FROM Trip_Participant WHERE trip_id = t.trip_id) AS currentParticipants
		  FROM Trip t
		  JOIN Trip_Participant tp ON t.trip_id = tp.trip_id
		 WHERE tp.user_id = #{userId}
		 ORDER BY t.start_date ASC
	</select>

	<select id="selectTripById" resultType="com.ssafy.gitaek.model.Trip">
		SELECT t.trip_id AS tripId, 
		       t.title, 
		       t.style,
		       t.description,
		       t.start_date AS startDate, 
		       t.end_date AS endDate, 
		       t.owner_id AS ownerId, 
		       t.max_participants AS maxParticipants, t.region_id AS regionId, 
		       t.current_editor_id AS currentEditorId,
		       t.invite_code AS inviteCode,
		       (SELECT COUNT(*) FROM Trip_Participant WHERE trip_id = t.trip_id) AS currentParticipants
		  FROM Trip t
		 WHERE t.trip_id = #{tripId}
	</select>

	<delete id="deleteTrip">
		DELETE FROM Trip WHERE trip_id = #{tripId}
	</delete>

	<insert id="registSchedule" parameterType="com.ssafy.gitaek.dto.TripScheduleDto">
		INSERT INTO Trip_Schedule (
		trip_id, poi_id, trip_day, visit_order, memo, schedule_time,
		duration, travel_time  )
		VALUES (
		#{tripId}, #{poiId}, #{tripDay},
		(SELECT IFNULL(MAX(visit_order), 0) + 1 FROM Trip_Schedule T WHERE trip_id=#{tripId} AND trip_day=#{tripDay}),
		#{memo}, #{scheduleTime},
		#{duration}, #{travelTime}  )
	</insert>

	<select id="selectSchedulesByTripId" resultType="com.ssafy.gitaek.dto.TripScheduleDto">
		SELECT
		s.schedule_id AS scheduleId,
		s.trip_day AS tripDay,
		s.visit_order AS visitOrder,
		s.memo,
		s.schedule_time AS scheduleTime,

		s.duration,                  s.travel_time AS travelTime, s.poi_id AS poiId,
		p.name AS placeName,
		p.address AS placeAddress,
		p.latitude AS placeLat,
		p.longitude AS placeLng,
		p.thumbnail_url AS thumbnailUrl
		FROM Trip_Schedule s
		JOIN POI p ON s.poi_id = p.poi_id
		WHERE s.trip_id = #{tripId}
		ORDER BY s.trip_day, s.visit_order
	</select>

	<delete id="deleteSchedule">
		DELETE FROM Trip_Schedule WHERE trip_id = #{tripId}
		AND trip_day = #{tripDay} AND poi_id = #{poiId}
	</delete>

	<update id="updateCurrentEditor">
		UPDATE Trip SET current_editor_id = #{userId} WHERE
		trip_id = #{tripId}
	</update>

	<select id="checkParticipant" resultType="int">
		SELECT COUNT(*) FROM
		Trip_Participant WHERE trip_id = #{tripId} AND user_id = #{userId}
	</select>

	<delete id="deleteParticipant">
		DELETE FROM Trip_Participant WHERE trip_id = #{tripId} AND user_id =
		#{userId}
	</delete>

	<delete id="deleteTripParticipants">
		DELETE FROM Trip_Participant WHERE trip_id = #{tripId}
	</delete>

	<select id="selectTripByInviteCode"
		resultType="com.ssafy.gitaek.model.Trip">
		SELECT * FROM Trip WHERE invite_code = #{inviteCode}
	</select>
	
	<delete id="deleteTripsByOwnerId">
        DELETE FROM Trip WHERE owner_id = #{ownerId}
    </delete>

</mapper>