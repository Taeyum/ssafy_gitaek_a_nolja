<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.gitaek.mapper.TripMapper">

    <insert id="insertTrip" parameterType="com.ssafy.gitaek.model.Trip" useGeneratedKeys="true" keyProperty="tripId">
        INSERT INTO Trip (
        title, style, description, start_date, end_date,
        owner_id, max_participants, region_id, created_at, invite_code
        )
        VALUES (
        #{title}, #{style}, #{description}, #{startDate}, #{endDate},
        #{ownerId}, #{maxParticipants}, 1, NOW(), #{inviteCode}
        )
    </insert>

    <select id="selectTripByInviteCode" resultType="com.ssafy.gitaek.model.Trip">
        SELECT * FROM Trip WHERE invite_code = #{inviteCode}
    </select>

    <select id="checkParticipant" resultType="int">
        SELECT COUNT(*) FROM Trip_Participant
        WHERE trip_id = #{tripId} AND user_id = #{userId}
    </select>

    <insert id="insertParticipant">
        INSERT INTO Trip_Participant (trip_id, user_id, joined_at, role)
        VALUES (#{tripId}, #{userId}, NOW(), #{role})
    </insert>

    <select id="selectMyTrips" parameterType="int" resultType="com.ssafy.gitaek.model.Trip">
        SELECT
        t.*,
        (SELECT COUNT(*) FROM Trip_Participant tp2 WHERE tp2.trip_id = t.trip_id) as currentParticipants
        FROM Trip t
        JOIN Trip_Participant tp ON t.trip_id = tp.trip_id
        WHERE tp.user_id = #{userId}
        ORDER BY t.start_date DESC
    </select>

    <select id="selectTripById" resultType="com.ssafy.gitaek.model.Trip">
        SELECT
        t.*,
        (SELECT COUNT(*) FROM Trip_Participant tp WHERE tp.trip_id = t.trip_id) as currentParticipants
        FROM Trip t
        WHERE t.trip_id = #{tripId}
    </select>

    <delete id="deleteParticipant">
        DELETE FROM Trip_Participant
        WHERE trip_id = #{tripId} AND user_id = #{userId}
    </delete>

    <delete id="deleteTripParticipants">
        DELETE FROM Trip_Participant WHERE trip_id = #{tripId}
    </delete>

    <delete id="deleteTrip">
        DELETE FROM Trip WHERE trip_id = #{tripId}
    </delete>

    <insert id="registSchedule" parameterType="com.ssafy.gitaek.dto.TripScheduleDto">
        INSERT INTO Trip_Schedule (trip_id, poi_id, trip_day, visit_order, memo, schedule_time)
        VALUES (#{tripId}, #{poiId}, #{tripDay}, #{visitOrder}, #{memo}, #{scheduleTime})
    </insert>

    <select id="selectSchedulesByTripId" resultType="com.ssafy.gitaek.dto.TripScheduleDto">
        SELECT
        s.trip_id, s.poi_id, s.trip_day, s.visit_order, s.memo, s.schedule_time, p.name as placeName,
        p.address as placeAddress,
        p.latitude as placeLat,
        p.longitude as placeLng
        FROM Trip_Schedule s
        JOIN POI p ON s.poi_id = p.poi_id
        WHERE s.trip_id = #{tripId}
        ORDER BY s.trip_day ASC, s.visit_order ASC
    </select>

    <delete id="deleteSchedule">
        DELETE FROM Trip_Schedule
        WHERE trip_id = #{tripId}
        AND trip_day = #{tripDay}
        AND poi_id = #{poiId}
    </delete>

    <update id="updateCurrentEditor">
        UPDATE Trip SET current_editor_id = #{userId} WHERE trip_id = #{tripId}
    </update>
</mapper>